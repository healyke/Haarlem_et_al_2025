---
title: "Pace of ecology drives temporal perception across the Animal Kingdom"
author: "Haarlem, C., Hynes, C,. Jackson, A.L., Healy, K."
date: "17/10/2025"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

# Introduction

This document outlines the analysis used for the publication Haarlem et al 
(Pace of ecology drives temporal perception across the Animal Kingdom).
The script comprises of a phylogeny comparative analysis testing if different 
trophic strategies, volancy, body size and light level affect the critical 
flicker fusion of animals in marine and non-marine habitats. The analysis
comprises a phylogentic comparative approach in a Bayesian framework using the
`MCMCglmm` package and the `mulTree` package to incorporate uncertainly in 
the phylogeny itself. 

Please see main document for details on methods and data collection.

# Loading packages

The main packages used are `MCMCglmm` for the Bayesian comparative analysis as
this package can allow for correcting for phylogeny using the animal term. More 
details on the package can be found here (https://www.jstatsoft.org/article/view/v033i02)

To upload the phylogeny and for other functions associated with handling the
phylogeny we used the `phytools`, `plotrix` and `caper` packages.

To incorporate the uncertinty associated with building phylogenies we used the
`mulTree` package which is downladed from github. This packages is a wrapper
that loops the MCMCglmm function across a given distribution of phylogenies. It
automatically writes the model outputs outside the R environment to avoid issues
with RAM availble in the R envirnment. For more details see 
(https://github.com/TGuillerme/mulTree)

package and `Multree` package

```{r packages, eval=TRUE, message=FALSE, warning=FALSE}

#If you need to install any of these packages run this line
#install.packages("phytools","caper","MCMCglmm","hdrcde")
library(phytools)
library(caper)
library(MCMCglmm)
library(hdrcde)
library(plotrix)

#If you need to install mulTree run these lines
#if(!require(devtools)) install.packages("devtools")
#library(devtools)
#install_github("TGuillerme/mulTree", ref = "release")
library(mulTree)

```

\newpage
# Data

Next we load in the dataset Haarlem_et_al_cff_dataset_21_10_2025.csv.

We will also add a colunm for log10 of CFF which will be the response variable
and set sessile_food as the baseline category for the mode_of_life variable and
terrestrial as the baseline for the habitat variable.

```{r setup, include=FALSE}

cff_raw <- read.csv("Haarlem_et_al_cff_dataset_21_10_2025.csv", 
                    header = T,
                    sep = ",")

#Create a varaible for log10(CFF)
cff_raw$CFF_log <- log10(cff_raw$CFF)


#Set sessile_food as the baseline
cff_raw$mode_of_life <- factor(cff_raw$mode_of_life, 
                                  levels = c("sessile_food",   
                                             "ballistic",   
                                             "pursuit"
                                             ))

#Set terrestrial as the baseline
cff_raw$habitat <- factor(cff_raw$habitat, 
                                  levels = c("terrestrial",
                                             "nektonic", 
                                             "demersal",
                                             "volant"
                                             ))
  
 
cff_clean <- cff_raw[,c("Species_phylo",
                        "Class",
                        "habitat",
                        "forage_light_level",
                        "body_mass",
                        "mode_of_life",
                        "Method",
                        "CFF",
                        "CFF_log")]
 

cff_clean <- data.frame(cff_clean, animal = cff_clean$Species_phylo)

```

# Phylogeny 

Read in the phylogeny Haarlem_et_al_tree.tre which is a supertree constructed
by combining various published phylogeny. For more details see the 
supplementary S1. We can plot out one of the phylogenies.


```{r phylo, fig.align = 'center'}

cff_tree <- read.tree("Haarlem_et_al_tree.tre")

plot(cff_tree[[1]], 
     type = "fan",
     cex = 0.15)
```

We can also plot the phylogeny with cff values indicated by bars. I combine the 
normal plot with the barplot in inkscape to create figure 2.

```{r phylo bar plot, fig.align = 'center'}



cff_phylo_plot_cff <- c()
cff_phylo_plot_light <- c()
cff_phylo_plot_species <- c()

for(i in 1:length(unique(cff_clean$Species_phylo))){
  
 cff_phylo_plot_species[i] <-  unique(cff_clean$Species_phylo)[i]
 cff_phylo_plot_light[i] <-  cff_clean[cff_clean$Species_phylo == 
                                         unique(cff_clean$Species_phylo)[i], 
                                       "forage_light_level"][1]
 cff_phylo_plot_cff[i] <-  max(cff_clean[cff_clean$Species_phylo == 
                                           unique(cff_clean$Species_phylo)[i], 
                                         "CFF"])

}


cff_phylo_plot <- data.frame(cff_phylo_plot_species,
                             cff_phylo_plot_light,
                             cff_phylo_plot_cff)


#create data with rownames for p
rownames(cff_phylo_plot) <- cff_phylo_plot$cff_phylo_plot_species

plots_v <- fastBM(cff_tree[[1]],bounds=c(0,Inf))

for(i in 1:length(cff_phylo_plot$cff_phylo_plot_species)){
  
  plots_v[i] <- cff_phylo_plot[cff_phylo_plot$cff_phylo_plot_species == 
                                 names(plots_v)[i],
                               "cff_phylo_plot_cff"]
}


CFF_plot_val <-setNames(cff_phylo_plot$cff_phylo_plot_cff,
              rownames(cff_phylo_plot))

par(mar=c(4.1,4.1,4.1,2.1))

plotTree.wBars(cff_tree[[1]], 
                CFF_plot_val,
     type = "fan",
     scale = 0.5,
     tip.labels = F)

```


# Main models

For the main analysis we will both marine and terrestrial species into one model.
First we set up a multree object which will contain the data and the distribution
of 100 phylogenies. We will also set what the random terms which will include 
the animal term for the phylogentic effect and a term for speies level variation
we will call Species_phylo.

```{r Multree data, include=FALSE}

cff_mul <- as.mulTree(cff_clean, 
                      cff_tree, 
                      taxa = "animal", 
                      rand.terms = ~animal + Species_phylo,
                      clean.data = FALSE)


```

Next we set the number of iterations (nitt) the thinning (thin) and the burnin
(burnin) and save them as the vector parameters. These parameters were set based
on previous runs and inspection to ensure that the MCMC chains are long enough to 
converge and have an effective samples size > 1000.

```{r parameters}

nitt <- 240000
thin <- 100
burnin <- 40000

parameters <- c(nitt,
                thin,
                burnin)

```

Next we set the priors to be non informative based on the recommendation of 
Hadfield, J. D. & Nakagawa (2010).

```{r prior}
prior <-list(R = list(V = 1, nu=0.002), 
             G = list(G1=list(V = 1,n = 2, 
                              nu=0.002),
                      G2=list(V = 1,n = 2, 
                              nu=0.002)
                     ))


```

Finally we set the mulTree model to run. Note that here we will not set it to 
run here due to the long run time. Instead we will read in a previous model below.
If you wish to run the model simply run the block of code below. 

```{r mulTree, eval=FALSE, include=TRUE}

mulTree(mulTree.data = cff_mul, 
        formula = CFF_log ~ log10(body_mass_us)*forage_light_level 
                                  + mode_of_life
                                  + habitat
                                  + Method,
        parameters = parameters, 
        chains = 3,
        priors = prior,
        convergence = 1.1, 
        ESS = 1000, 
        verbose = TRUE,
        output = "mulTree_models", 
        warn = FALSE, 
        ask = TRUE)

```


After the models have run (or in this case using the models we previously ran) 
we can read them in. In this case we will read in the fixed terms as the 
Main_models and the random terms as the Main_models_sp

```{r upload models}

Main_models <-   read.mulTree(mulTree.chain = "mulTree_models", 
                              convergence = FALSE, 
                              model = FALSE)

Main_models_sp <-   read.mulTree(mulTree.chain = "mulTree_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = c("VCV"))

```

We can now simply use summary to see the  model output for the combined postior 
distributions across the full set of 100 trees

```{r summary main}

print(summary(Main_models)[,c(1,2,5)], 
      digits = 2)

```
We can see from this output that the 95% CI does not cross zero for light levels,
with species in lower light environments having lower CFF, for ballistic and 
pursuit foraging,with both these groups having higher CFF values compared to
species which feed on sessile food sources, for volant species, with volant 
species having a higher CFF compared to non-volant species and for CFF values 
with Electrophysiology methods compared to behavioral approaches. 

We can also look at the varaince terms in more detail.

```{r var main}

#phylo term
phylo_animal <- list()
for(i in 1:length(Main_models_sp)){
phylo_animal[[i]] <- Main_models_sp[[1]][,"animal"]
}
phylo_animal <- unlist(phylo_animal)


#species term
sp_rand <- list()
for(i in 1:length(Main_models_sp)){
sp_rand[[i]] <- Main_models_sp[[1]][,"Species_phylo"]
}
sp_rand <- unlist(sp_rand)


#resids term

resids_rand <- list()
for(i in 1:length(Main_models_sp)){
resids_rand[[i]] <- Main_models_sp[[1]][,"units"]
}
resids_rand <- unlist(resids_rand)

random_main_terms_summary <- data.frame(phylo_animal, 
                                        sp_rand, 
                                        resids_rand)
summary(random_main_terms_summary)
```


lets also look at the H2 value for the model which will tell use the level of
phylogeny signal in our model.

```{r H2 main model}
# Calculate H2
H_main <- phylo_animal/c(phylo_animal + sp_rand + resids_rand)
H_out <- list(mode = hdr(H_main)$mode,
              CI_95 = hdr(H_main)$hdr[2,1:2])
H_out
```

In this case the mode H2 value is 0.79 with a 95% CI of 0.63-0.88 indicating an
overall high level of phylogentic signal in the data.

If we want we can check each individual model separately. Lets look at the model 
for two chains of the first tree. Doing this will give all the standard output 
from a MCMCglmm object. To do so we read them in with model = T and the specific
model named.


```{r Indavidual model}

Main_models_c1 <-   read.mulTree(mulTree.chain = "mulTree_models-tree1_chain1", 
                              convergence = FALSE, 
                              model = T)

Main_models_c2 <-   read.mulTree(mulTree.chain = "mulTree_models-tree1_chain2", 
                              convergence = FALSE, 
                              model = T)


summary(Main_models_c1)

```

We can also plot the output from the first model. For example, we can look at 
the trace of the posterior distribution for light levels.

```{r plot first}

plot(Main_models_c1$Sol[,3])

```

We can also check out the auto-corrolation using the `acf()` function

```{r plot acf}

acf(Main_models_c1$Sol[,3])

```

We next want to check the convergence for our models. We can check convergence 
between two chains for single models like below.

```{r convergance}
gelman.diag(mcmc.list(Main_models_c1$Sol,
            Main_models_c2$Sol))

```


We see that the values are less than 1.1 which indicates convergance. However, 
mulTree checks for convergance while running and will send a flag if 
either convergence fails or the ESS is below 1000 for any set of chain across the
100 trees, hence this has all been checked while running the models. However, 
we can pull the convergence checks across all models as a list by reading them
in using read.mulTree and ask if any of the Rubin Gelman values are greater than
1.1.

```{r show convergance}

convergance_check <-  read.mulTree(mulTree.chain = "mulTree_models", 
                              convergence = T, 
                              model = F)

any(unlist(convergance_check) >1.1)

```

We can see that there is no model with a value greater than 1.1 so its clear the
chains have converged.

# Main plots

We can now do the plots for the main analysis. These are the raw versions here
with silhouettes added in inkscape. The first plot is for figure 3 which compares
habitat type of terrestrial, nektonic, demersal and volant. 

```{r plot habitat}

plot(log10(cff_clean[, "CFF"]) ~ jitter(as.numeric(cff_clean[, "habitat"])),
       col = "white",
       pch= 16,
     bty = "n",
     xlim = c(0.5,4.5),
      xaxt = "n",
     ylab = "Log10 CFF",
     )

axis(1, at=1:4, labels= c("terrestrial", 
                          "nektonic", 
                          "demersal", 
                          "volant"))


#For ease we will save the estimates for each of the parameters here.
inter_main_p <-  hdr(Main_models$`(Intercept)`)
mass_log10_main_p <-  hdr(Main_models$`log10(body_mass_us)`)
lit_low_main_p <-  hdr(Main_models$forage_light_levellow)
ballistic_main_p <-  hdr(Main_models$mode_of_lifeballistic)
pur_main_p <-  hdr(Main_models$mode_of_lifepursuit)
nek_main_p <-  hdr(Main_models$habitatpelagic)
dem_main_p <-  hdr(Main_models$habitatdemersal)
vol_main_p <-  hdr(Main_models$habitatvolant)
body_lit_inter_main_p <-  hdr(Main_models$`log10(body_mass_us):forage_light_levellow`)



points(log10(cff_clean[cff_clean$forage_light_level == "low", "CFF"]) ~ 
         jitter(as.numeric(cff_clean[cff_clean$forage_light_level == "low", "habitat"]), 
                0.5),
       col = "grey70",
       pch= 16)

points(log10(cff_clean[cff_clean$forage_light_level == "high", "CFF"]) 
       ~ jitter(as.numeric(cff_clean[cff_clean$forage_light_level == "high", 
                                     "habitat"]), 0.5),
       col = rgb(247/250,224/250,89/250),
       pch= 16)



points(1,median(log10(cff_clean[cff_clean$forage_light_level == "high" 
                                & cff_clean$habitat == "terrestrial", "CFF"])),
       col = "orange",
       pch= 3)

points(1,median(log10(cff_clean[cff_clean$forage_light_level == "low" 
                                & cff_clean$habitat == "terrestrial", "CFF"])),
       col = "grey40",
       pch= 3)



points(2,median(log10(cff_clean[cff_clean$forage_light_level == "high" 
                                & cff_clean$habitat == "nektonic", "CFF"])),
       col = "orange",
       pch= 3)

points(2,median(log10(cff_clean[cff_clean$forage_light_level == "low" 
                                & cff_clean$habitat == "nektonic", "CFF"])),
       col = "grey40",
       pch= 3)


points(3,median(log10(cff_clean[cff_clean$forage_light_level == "high" 
                                & cff_clean$habitat == "demersal", "CFF"])),
       col = "orange",
       pch= 3)

points(3,median(log10(cff_clean[cff_clean$forage_light_level == "low" 
                                & cff_clean$habitat == "demersal", "CFF"])),
       col = "grey40",
       pch= 3)


points(4,median(log10(cff_clean[cff_clean$forage_light_level == "high" 
                                & cff_clean$habitat == "volant", "CFF"])),
       col = "orange",
       pch= 3)

points(4,median(log10(cff_clean[cff_clean$forage_light_level == "low" 
                                & cff_clean$habitat == "volant", "CFF"])),
       col = "grey40",
       pch= 3)

```


\newpage

# Terrestrial model

As before we need to set the data and phylogeny into a Multree object. First we
need to subset to just the non-marine species.

```{r terrestrial subset data}

#Subset to just volant and terrestrial sepcies
cff_t <- cff_clean[cff_clean$habitat %in% c("volant", 
                                        "terrestrial"
                                        ),]

#reset the habitat factors to have just two levels of terrestrial and volant
cff_t$habitat <- factor(cff_t$habitat, 
                                  levels = c("terrestrial",   
                                             "volant"
                                             ))
#Put it in a Multree object.
cff_mul_terr <- as.mulTree(cff_t, 
                      cff_tree, 
                      taxa = "animal", 
                      rand.terms = ~animal + Species_phylo,
                      clean.data = FALSE)


```


As before we can run these models but given they take some time we can upload
the model that have been run previously. 

```{r multre terr, eval=FALSE, include=TRUE}


mulTree(mulTree.data = cff_mul_terr, 
        formula = CFF_log ~ log10(body_mass_us)*forage_light_level 
                                  + mode_of_life
                                  + habitat    
                                  + Method,
        parameters = parameters, 
        chains = 3,
        priors = prior,
        convergence = 1.1, 
        ESS = 1000, 
        verbose = TRUE,
        output = "cff_terr_models", 
        warn = FALSE, 
        ask = TRUE)


```

We can now read in the model results for the terrestrial models


```{r terr sum}

ter_models <-   read.mulTree(mulTree.chain = "cff_terr_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = NULL)


ter_models_sp <-   read.mulTree(mulTree.chain = "cff_terr_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = "VCV")

print(summary(ter_models)[,c(1,2,5)], digits = 2)
```

Like in the main model the factors with high support as indicated by the 95% CI
not crossing zero includes light level, with low light species having lower CFF
and volancy, with volant species having higher CFF values. We also see strong 
support for a negative interaction term for body size and light levels. However,
body size was not strongly support as a factor and in this model the support for 
a posative effect associated with pursuit predators is lower which there is now a
negative relationship, although it is only weakly supported, for ballistic species.

Like before we can also look at the phylogentic signal in more detail.

```{r random sum, include=FALSE}

#phylo term
phylo_t_animal <- list()
for(i in 1:length(ter_models_sp)){
phylo_t_animal[[i]] <- ter_models_sp[[1]][,"animal"]
}
phylo_t_animal <- unlist(phylo_t_animal)

#species term
sp_t_rand <- list()
for(i in 1:length(ter_models_sp)){
sp_t_rand[[i]] <- ter_models_sp[[1]][,"Species_phylo"]
}
sp_t_rand <- unlist(sp_t_rand)


#resids term
resids_t_rand <- list()
for(i in 1:length(ter_models_sp)){
resids_t_rand[[i]] <- ter_models_sp[[1]][,"units"]
}
resids_t_rand <- unlist(resids_t_rand)

random_terr_terms_summary <- data.frame(resids_t_rand, 
                                        sp_t_rand,
                                        phylo_t_animal)
summary(random_terr_terms_summary)

```



```{r phyloe terr}
H_terr <- phylo_t_animal/c(phylo_t_animal + sp_t_rand + resids_t_rand)
hdr(H_terr)

```

Similar to the main model the H2 value is 0.86 indicating a strong phylogentic 
effect.

We can also plot the output from the first model

```{r Indavidual model terr}

terr_models_c1 <-   read.mulTree(mulTree.chain = "cff_terr_models-tree1_chain1", 
                              convergence = FALSE, 
                              model = T)

terr_models_c2 <-   read.mulTree(mulTree.chain = "cff_terr_models-tree1_chain2", 
                              convergence = FALSE, 
                              model = T)
summary(terr_models_c1)
```


and check convergence between the first two chains


```{r convergance terr}
gelman.diag(mcmc.list(terr_models_c1$Sol,
            terr_models_c2$Sol))

```

However, mulTree checks for convergance while running and will send flag if 
either convergence fails or the ESS is below 1000 so this has all been checked.
We can pull the convergance checks across all models as a list by reading them
in using read.mulTree and ask if any of the Rubin Gelman values are greater than
1.1.

```{r show convergance terr}

convergance_terr_check <-  read.mulTree(mulTree.chain = "cff_terr_models", 
                              convergence = T, 
                              model = F)

any(unlist(convergance_terr_check) >1.1)

```

Finally, we can plot the volant versus nonvolant. 

```{r terrestrial jitter,}

plot(log10(cff_t[, "CFF"]) ~ jitter(as.numeric(cff_t[, "habitat"])),
       col = "white",
       pch= 16,
     bty = "n",
     xlim = c(0.5,2.5),
      xaxt = "n",
     ylab = "Log10 CFF",
     )

axis(1, at=1:2, labels= c("terrestrial", 
                          "volant"))

points(log10(cff_t[cff_t$forage_light_level == "low", "CFF"]) 
       ~ jitter(as.numeric(cff_t[cff_t$forage_light_level == "low", "habitat"]), 
                0.5),
       col = "grey70",
       pch= 16)

points(log10(cff_t[cff_t$forage_light_level == "high", "CFF"]) 
       ~ jitter(as.numeric(cff_t[cff_t$forage_light_level == "high", "habitat"]), 
                0.5),
       col = rgb(247/250,224/250,89/250),
       pch= 16)

```

\newpage

# Marine models

The final models focus on the just marine species so first we need to subset
and make a Multree object.

```{r marine data}

cff_m <- cff_clean[cff_clean$habitat %in% c("nektonic", 
                                        "demersal"
                                        ),]

cff_m$habitat <- factor(cff_m$habitat, 
                                  levels = c("demersal",
                                             "nektonic" 
                                        ))


cff_mul_mar <- as.mulTree(cff_m, 
                      cff_tree, 
                      taxa = "animal", 
                      rand.terms = ~animal + Species_phylo,
                      clean.data = FALSE)


```

As in the other models if you wish to rerun the models across all 100 tree the 
code below will do it and export the output to the current working directory 
folder. However, to avoid long run times here we will skip this step and upload
the model results from a previous run.


```{r marine model, eval=FALSE, include=TRUE}


mulTree(mulTree.data = cff_mul_mar, 
        formula = CFF_log ~ log10(body_mass_us)*forage_light_level 
                                  + mode_of_life
                                  + habitat
                                  + Method,
        parameters = parameters, 
        chains = 3,
        priors = prior,
        convergence = 1.1, 
        ESS = 1000, 
        verbose = TRUE,
        output = "cff_mar_models", 
        warn = FALSE, 
        ask = TRUE)

```


Read in the multiple marine models and get an overall summary of the results.

```{r marine read}

mar_models <-   read.mulTree(mulTree.chain = "cff_mar_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = NULL)

mar_models_sp <-   read.mulTree(mulTree.chain = "cff_mar_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = "VCV")

print(summary(mar_models)[,c(1,2,5)], digits = 2)

```

Similar to the main overall model and the terrestrial model light levels are 
strongly supported, with species in low light environments associated with lower 
CFF values. The is strong support for ballistic predators having higher CFF values
compared to species that forage on sessile food items and while slightly weaker,
as the 95% CI crosses zero, there is some support for pursuit predators also 
having higher CFF values. Notable, an effect for body size is strongly supported 
in marine species with larger species having a lower CFF value and there is also
strong support for for a negative interaction term between body mass and 
light levels. While still a positive effect the associated with Electrophysiology
methods is not strongly supported in this model.


```{r marine random}

#phylo term
phylo_m_animal <- list()
for(i in 1:length(mar_models_sp)){
phylo_m_animal[[i]] <- mar_models_sp[[1]][,"animal"]
}
phylo_m_animal <- unlist(phylo_m_animal)

#species term
sp_m_rand <- list()
for(i in 1:length(mar_models_sp)){
sp_m_rand[[i]] <- mar_models_sp[[1]][,"Species_phylo"]
}
sp_m_rand <- unlist(sp_m_rand)


#resids term

resids_m_rand <- list()
for(i in 1:length(mar_models_sp)){
resids_m_rand[[i]] <- mar_models_sp[[1]][,"units"]
}
resids_m_rand <- unlist(resids_m_rand)

marine_rand <- data.frame(phylo_m_animal,
                          sp_m_rand, 
                          resids_m_rand)

summary(marine_rand)

```

We can also calculate the H2 value for the marine model

```{r marine h2}

m_terr <- phylo_m_animal/c(phylo_m_animal + sp_m_rand + resids_m_rand)
hdr(m_terr)

```

Like in the previous models the H2 value is high, at 0.93, indicating a 
strong phylogentic signal.


We can no also plot the relationship between the foraging stratagy,

```{r marine jitter}


plot(log10(cff_m[, "CFF"]) ~ jitter(as.numeric(cff_m[, "mode_of_life"])),
       col = "white",
       pch= 16,
     bty = "n",
     xlim = c(0.5,3.5),
      xaxt = "n",
     ylab = "Log10 CFF",
     )

axis(1, at=1:3, labels= c("forage", 
                          "ballistic", 
                          "pursuit"))

points(log10(cff_m[cff_m$forage_light_level == "low", "CFF"]) 
       ~ jitter(as.numeric(cff_m[cff_m$forage_light_level == "low" 
                                 & cff_m$habitat != "volant", "mode_of_life"]), 
                0.5),
       col = "grey70",
       pch= 16)

points(log10(cff_m[cff_m$forage_light_level == "high", "CFF"]) 
       ~ jitter(as.numeric(cff_m[cff_m$forage_light_level == "high", 
                                 "mode_of_life"]), 
                0.5),
       col = rgb(247/250,224/250,89/250),
       pch= 16)


```

