---
title: "New_cff"
author: "Kevin Healy"
date: "17/11/2020"
output: html_document
---



```{r packages, tidy = TRUE, results = "hide"}

library(phytools)
library(caper)
library(MCMCglmm)
library(hdrcde)
library(mulTree)
#source("MultiDisPlot.R")
```


Read in the data

```{r setup, include=FALSE}

cff_raw <- read.csv("Full_CFF_working_9_9_24.csv", 
                    header = T,
                    sep = ",")

cff_raw$CFF_log <- log10(cff_raw$CFF)

#This drops a couple of studies that are not up to scratch as measures
cff_raw <- cff_raw[cff_raw$Critical_appraisal_keep == "y",]

#Set forage as the baseline
cff_raw$mode_of_life <- factor(cff_raw$mode_of_life, 
                                  levels = c("forage",   
                                             "ballistic",   
                                             "pursuit"
                                             ))

#Set terrestrial as the baseline
cff_raw$habitat <- factor(cff_raw$habitat, 
                                  levels = c("terrestrial",
                                             "pelagic", 
                                             "demersal",
                                             "volant"
                                             ))
  
 
cff_clean <- cff_raw[,c("Species_phylo",
                        "Class",
                        "habitat",
                        "forage_light_level",
                        "body_mass_us",
                        "mode_of_life",
                        "Method",
                        "CFF",
                        "CFF_log")]
 

cff_clean <- data.frame(cff_clean, animal = cff_clean$Species_phylo)

cff_clean <- na.omit(cff_clean)

```


Read in the phylogeny and make sure it matches the data.

```{r phylo, include=FALSE}

cff_tree_raw <- read.tree("cff_tree_10_9_2024.tree")

cff_clean_un <- data.frame(spec = unique(cff_clean$Species_phylo),
                           spec2 = unique(cff_clean$Species_phylo))

cff_tree <- cff_tree_raw
for(i in 1:(length(cff_tree))){
  
  cff_tree[[i]] <- comparative.data(phy = cff_tree[[i]], 
                                      data = cff_clean_un, 
                                      names.col = "spec", 
                                      force.root = TRUE)$phy
}


```

We can plot the phylogeny, I combine the normal plot with the barplot in 
inkscape.

```{r phylo plot, include=FALSE}



cff_phylo_plot_cff <- c()
cff_phylo_plot_light <- c()
cff_phylo_plot_species <- c()

for(i in 1:length(unique(cff_clean$Species_phylo))){
  
 cff_phylo_plot_species[i] <-  unique(cff_clean$Species_phylo)[i]
 cff_phylo_plot_light[i] <-  cff_clean[cff_clean$Species_phylo == unique(cff_clean$Species_phylo)[i], "forage_light_level"][1]
 cff_phylo_plot_cff[i] <-  max(cff_clean[cff_clean$Species_phylo == unique(cff_clean$Species_phylo)[i], "CFF"])

}


cff_phylo_plot <- data.frame(cff_phylo_plot_species,
                             cff_phylo_plot_light,
                             cff_phylo_plot_cff)


#create data with rownames for p
rownames(cff_phylo_plot) <- cff_phylo_plot$cff_phylo_plot_species

plots_v <- fastBM(cff_tree[[1]],bounds=c(0,Inf))

for(i in 1:length(cff_phylo_plot$cff_phylo_plot_species)){
  
  plots_v[i] <- cff_phylo_plot[cff_phylo_plot$cff_phylo_plot_species == names(plots_v)[i],
                               "cff_phylo_plot_cff"]
}


CFF_plot_val <-setNames(cff_phylo_plot$cff_phylo_plot_cff,
              rownames(cff_phylo_plot))

par(mar=c(4.1,4.1,4.1,2.1))

plotTree.wBars(cff_tree[[1]], 
                CFF_plot_val,
     type = "fan",
     scale = 0.5,
     tip.labels = F)


plot(cff_tree[[1]],
          type = "fan",
          cex = 0.5)

```



#MulTree
Set the data into a Multree object so we can run the MCMCglmm over 100 
phylogenies once we are ready

```{r Multree data, include=FALSE}

cff_mul <- as.mulTree(cff_clean, 
                      cff_tree, 
                      taxa = "animal", 
                      rand.terms = ~animal + Species_phylo,
                      clean.data = FALSE)


```



##Set the parameters
Here we set the number of iterations, the thinning and the burn-in

```{r parameters}

nitt <- 240000
thin <- 100
burnin <- 40000

parameters <- c(nitt,
                thin,
                burnin)

```


##Set the prior

Set the prior.

```{r prior}
prior <-list(R = list(V = 1, nu=0.002), 
             G = list(G1=list(V = 1,n = 2, 
                              nu=0.002),
                      G2=list(V = 1,n = 2, 
                              nu=0.002)
                     ))


```


```{r glm, include=FALSE}

mulTree(mulTree.data = cff_mul, 
        formula = CFF_log ~ log10(body_mass_us)*forage_light_level 
                                  + mode_of_life
                                  + habitat
                                  + Method,
        parameters = parameters, 
        chains = 2,
        priors = prior,
        convergence = 1.1, 
        ESS = 1000, 
        verbose = TRUE,
        output = "mulTree_models", 
        warn = FALSE, 
        ask = TRUE)


#full_model_1 <- MCMCglmm(log10(CFF) ~ log10(body_mass_us)*forage_light_level 
#                                  + mode_of_life
#                                  + habitat
#                                  + Method,
#                         random = ~ animal + Species_phylo,
#                         rcov=~ units, 
#                          data = cff_clean, 
#                          pedigree = cff_tree[[1]], 
#                          prior = prior,
#                          family=c("gaussian"), 
#                          nitt = nitt, thin = thin, burnin = burnin,
#                          verbose= FALSE)

# summary(full_model_1)

```

#Read in the multiple runs

This needs to be fixed for when we run multiple trees

```{r glm, include=FALSE}

Main_models <-   read.mulTree(mulTree.chain = "mulTree_models", 
                              convergence = FALSE, 
                              model = FALSE)

Main_models_sp <-   read.mulTree(mulTree.chain = "mulTree_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = c("VCV"))

inter_main_p <-  hdr(Main_models$`(Intercept)`)
mass_log10_main_p <-  hdr(Main_models$`log10(body_mass_us)`)
lit_low_main_p <-  hdr(Main_models$forage_light_levellow)
ballistic_main_p <-  hdr(Main_models$mode_of_lifeballistic)
pur_main_p <-  hdr(Main_models$mode_of_lifepursuit)
pel_main_p <-  hdr(Main_models$habitatpelagic)
dem_main_p <-  hdr(Main_models$habitatdemersal)
vol_main_p <-  hdr(Main_models$habitatvolant)
body_lit_inter_main_p <-  hdr(Main_models$`log10(body_mass_us):forage_light_levellow`)

#phylo term
phylo_animal <- list()
for(i in 1:length(Main_models_sp)){
phylo_animal[[i]] <- Main_models_sp[[1]][,"animal"]
}
phylo_animal <- unlist(phylo_animal)
hdr(phylo_animal)

#species term
sp_rand <- list()
for(i in 1:length(Main_models_sp)){
sp_rand[[i]] <- Main_models_sp[[1]][,"Species_phylo"]
}

sp_rand <- unlist(sp_rand)
hdr(sp_rand)


#resids term

resids_rand <- list()
for(i in 1:length(Main_models_sp)){
resids_rand[[i]] <- Main_models_sp[[1]][,"units"]
}

resids_rand <- unlist(resids_rand)
hdr(resids_rand)

H_main <- phylo_animal/c(phylo_animal + sp_rand + resids_rand)
hdr(H_main)

```


plot habitat

```{r plot habitat, include=FALSE}

plot(log10(cff_clean[, "CFF"]) ~ jitter(as.numeric(cff_clean[, "habitat"])),
       col = "white",
       pch= 16,
     bty = "n",
     xlim = c(0.5,4.5),
      xaxt = "n",
     ylab = "Log10 CFF",
     )

axis(1, at=1:4, labels= c("terrestrial", 
                          "nektonic", 
                          "demersal", 
                          "volant"))

points(log10(cff_clean[cff_clean$forage_light_level == "low", "CFF"]) ~ jitter(as.numeric(cff_clean[cff_clean$forage_light_level == "low", "habitat"]), 0.5),
       col = "grey70",
       pch= 16)

points(log10(cff_clean[cff_clean$forage_light_level == "high", "CFF"]) ~ jitter(as.numeric(cff_clean[cff_clean$forage_light_level == "high", "habitat"]), 0.5),
       col = rgb(247/250,224/250,89/250),
       pch= 16)



points(1,median(log10(cff_clean[cff_clean$forage_light_level == "high" & cff_clean$habitat == "terrestrial", "CFF"])),
       col = "orange",
       pch= 3)

points(1,median(log10(cff_clean[cff_clean$forage_light_level == "low" & cff_clean$habitat == "terrestrial", "CFF"])),
       col = "grey40",
       pch= 3)



points(2,median(log10(cff_clean[cff_clean$forage_light_level == "high" & cff_clean$habitat == "pelagic", "CFF"])),
       col = "orange",
       pch= 3)

points(2,median(log10(cff_clean[cff_clean$forage_light_level == "low" & cff_clean$habitat == "pelagic", "CFF"])),
       col = "grey40",
       pch= 3)


points(3,median(log10(cff_clean[cff_clean$forage_light_level == "high" & cff_clean$habitat == "demersal", "CFF"])),
       col = "orange",
       pch= 3)

points(3,median(log10(cff_clean[cff_clean$forage_light_level == "low" & cff_clean$habitat == "demersal", "CFF"])),
       col = "grey40",
       pch= 3)


points(4,median(log10(cff_clean[cff_clean$forage_light_level == "high" & cff_clean$habitat == "volant", "CFF"])),
       col = "orange",
       pch= 3)

points(4,median(log10(cff_clean[cff_clean$forage_light_level == "low" & cff_clean$habitat == "volant", "CFF"])),
       col = "grey40",
       pch= 3)

```


plot foraging type

```{r plot forage, include=FALSE}

plot(log10(cff_clean[, "CFF"]) ~ jitter(as.numeric(cff_clean[, "mode_of_life"])),
       col = "white",
       pch= 16,
     bty = "n",
     xlim = c(0.5,3.5),
      xaxt = "n",
     ylab = "Log10 CFF",
     )

axis(1, at=1:3, labels= c("forage", 
                          "ballistic", 
                          "pursuit"))

points(log10(cff_clean[cff_clean$forage_light_level == "low" & cff_clean$habitat != "volant", "CFF"]) ~ jitter(as.numeric(cff_clean[cff_clean$forage_light_level == "low" & cff_clean$habitat != "volant", "mode_of_life"]), 0.5),
       col = "grey70",
       pch= 16)

points(log10(cff_clean[cff_clean$forage_light_level == "high" & cff_clean$habitat != "volant", "CFF"]) ~ jitter(as.numeric(cff_clean[cff_clean$forage_light_level == "high" & cff_clean$habitat != "volant", "mode_of_life"]), 0.5),
       col = rgb(247/250,224/250,89/250),
       pch= 16)



points(log10(cff_clean[cff_clean$forage_light_level == "low" & cff_clean$habitat == "volant", "CFF"]) ~ jitter(as.numeric(cff_clean[cff_clean$forage_light_level == "low" & cff_clean$habitat == "volant", "mode_of_life"]), 0.5),
       col = "grey70",
       pch= 17)

points(log10(cff_clean[cff_clean$forage_light_level == "high" & cff_clean$habitat == "volant", "CFF"]) ~ jitter(as.numeric(cff_clean[cff_clean$forage_light_level == "high" & cff_clean$habitat == "volant", "mode_of_life"]), 0.2),
       col = rgb(247/250,224/250,89/250),
       pch= 17)

#estimate value for forage low light
points(1,inter_main_p$mode + lit_low_main_p$mode, 
       pch = 19, 
       col = "grey30")

#estimate value for forage low light
points(1,inter_main_p$mode + lit_low_main_p$mode + vol_main_p$mode, 
       pch = 17, 
       col = "grey30")

#estimate value for forage high light
points(1,inter_main_p$mode, 
       pch = 19, 
       col = "gold2")

#estimate value for forage high light
points(1,inter_main_p$mode + vol_main_p$mode, 
       pch = 17, 
       col = "gold2")


#estimate value for ballistic low light
points(2,inter_main_p$mode + lit_low_main_p$mode + ballistic_main_p$mode, 
       pch = 19, 
       col = "grey30")

#estimate value for ballistic low light
points(2,inter_main_p$mode + lit_low_main_p$mode + vol_main_p$mode + ballistic_main_p$mode, 
       pch = 17, 
       col = "grey30")

#estimate value for ballistic high light
points(2,inter_main_p$mode + ballistic_main_p$mode, 
       pch = 19, 
       col = "gold2")

#estimate value for ballistic high light
points(2,inter_main_p$mode + vol_main_p$mode + ballistic_main_p$mode, 
       pch = 17, 
       col = "gold2")




#estimate value for pursuit
#estimate value for pursuit low light
points(3,inter_main_p$mode + lit_low_main_p$mode + pur_main_p$mode, 
       pch = 19, 
       col = "grey30")

#estimate value for ballistic low light
points(3,inter_main_p$mode + lit_low_main_p$mode + vol_main_p$mode + pur_main_p$mode, 
       pch = 17, 
       col = "grey30")

#estimate value for ballistic high light
points(3,inter_main_p$mode + pur_main_p$mode, 
       pch = 19, 
       col = "gold2")

#estimate value for ballistic high light
points(3,inter_main_p$mode + vol_main_p$mode + pur_main_p$mode, 
       pch = 17, 
       col = "gold2")




```





##terrestrial

#MulTree
Set the data into a Multree object.

```{r Multree data, include=FALSE}


cff_t <- cff_clean[cff_clean$habitat %in% c("volant", 
                                        "terrestrial"
                                        ),]

cff_t$habitat <- factor(cff_t$habitat, 
                                  levels = c("terrestrial",   
                                             "volant"
                                             ))

cff_mul_terr <- as.mulTree(cff_t, 
                      cff_tree, 
                      taxa = "animal", 
                      rand.terms = ~animal + Species_phylo,
                      clean.data = FALSE)


```



Run the terrestrial multree model

```{r multre terr, include=FALSE}


mulTree(mulTree.data = cff_mul_terr, 
        formula = CFF_log ~ log10(body_mass_us)*forage_light_level 
                                  + mode_of_life
                                  + habitat    
                                  + Method,
        parameters = parameters, 
        chains = 2,
        priors = prior,
        convergence = 1.1, 
        ESS = 1000, 
        verbose = TRUE,
        output = "cff_terr_models", 
        warn = FALSE, 
        ask = TRUE)


#full_ter_1 <- MCMCglmm(log10(CFF) ~ log10(body_mass_us)*forage_light_level 
#                                  + mode_of_life
#                                  + habitat
#                                  + Method,
#                         random = ~ animal + Species_phylo,
#                         rcov=~ units, 
#                         data = cff_t, 
#                         pedigree = cff_tree[[1]], 
#                         prior = prior,
#                         family=c("gaussian"), 
#                        nitt = nitt, thin = thin, burnin = burnin,
#                         verbose= FALSE)
#summary(full_ter_1)

```

Read in the multiple terrestrial models 

```{r glm, include=FALSE}

ter_models <-   read.mulTree(mulTree.chain = "cff_terr_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = NULL)


ter_models_sp <-   read.mulTree(mulTree.chain = "cff_terr_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = "VCV")

summary(ter_models)

#phylo term
phylo_t_animal <- list()
for(i in 1:length(ter_models_sp)){
phylo_t_animal[[i]] <- ter_models_sp[[1]][,"animal"]
}
phylo_t_animal <- unlist(phylo_t_animal)
hdr(phylo_t_animal)

#species term
sp_t_rand <- list()
for(i in 1:length(ter_models_sp)){
sp_t_rand[[i]] <- ter_models_sp[[1]][,"Species_phylo"]
}

sp_t_rand <- unlist(sp_t_rand)
hdr(sp_t_rand)


#resids term

resids_t_rand <- list()
for(i in 1:length(ter_models_sp)){
resids_t_rand[[i]] <- ter_models_sp[[1]][,"units"]
}

resids_t_rand <- unlist(resids_t_rand)
hdr(resids_t_rand)

H_terr <- phylo_t_animal/c(phylo_t_animal + sp_t_rand + resids_t_rand)
hdr(H_terr)



```



Plot volant versus non volant

```{r volatn jitter, include=FALSE}

plot(log10(cff_t[, "CFF"]) ~ jitter(as.numeric(cff_t[, "habitat"])),
       col = "white",
       pch= 16,
     bty = "n",
     xlim = c(0.5,2.5),
      xaxt = "n",
     ylab = "Log10 CFF",
     )

axis(1, at=1:2, labels= c("terrestrial", 
                          "volant"))

points(log10(cff_t[cff_t$forage_light_level == "low", "CFF"]) ~ jitter(as.numeric(cff_t[cff_t$forage_light_level == "low", "habitat"]), 0.5),
       col = "grey70",
       pch= 16)

points(log10(cff_t[cff_t$forage_light_level == "high", "CFF"]) ~ jitter(as.numeric(cff_t[cff_t$forage_light_level == "high", "habitat"]), 0.5),
       col = rgb(247/250,224/250,89/250),
       pch= 16)

```


##Marine analysis


```{r marine data, include=FALSE}

cff_m <- cff_clean[cff_clean$habitat %in% c("pelagic", 
                                        "demersal"
                                        ),]

cff_m$habitat <- factor(cff_m$habitat, 
                                  levels = c("demersal",
                                             "pelagic" 
                                        ))


cff_mul_mar <- as.mulTree(cff_m, 
                      cff_tree, 
                      taxa = "animal", 
                      rand.terms = ~animal + Species_phylo,
                      clean.data = FALSE)


```




```{r marine model, include=FALSE}


mulTree(mulTree.data = cff_mul_mar, 
        formula = CFF_log ~ log10(body_mass_us)*forage_light_level 
                                  + mode_of_life
                                  + habitat
                                  + Method,
        parameters = parameters, 
        chains = 2,
        priors = prior,
        convergence = 1.1, 
        ESS = 1000, 
        verbose = TRUE,
        output = "cff_mar_models", 
        warn = FALSE, 
        ask = TRUE)


#full_mar_1 <- MCMCglmm(log10(CFF) ~ log10(body_mass_us)*forage_light_level 
#                                  + mode_of_life
#                                  + habitat
#                                  + Method
                       ,
                         random = ~ animal + Species_phylo,
                         rcov=~ units, 
                         data = cff_m, 
                         pedigree = cff_tree[[1]], 
                         prior = prior,
                         family=c("gaussian"), 
                         nitt = nitt, thin = thin, burnin = burnin,
                         verbose= FALSE)
summary(full_mar_1)

```



Read in the multiple marine models 

```{r marine read, include=FALSE}

mar_models <-   read.mulTree(mulTree.chain = "cff_mar_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = NULL)

summary(mar_models)

mar_models_sp <-   read.mulTree(mulTree.chain = "cff_mar_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = "VCV")



#phylo term
phylo_m_animal <- list()
for(i in 1:length(mar_models_sp)){
phylo_m_animal[[i]] <- mar_models_sp[[1]][,"animal"]
}
phylo_m_animal <- unlist(phylo_m_animal)
hdr(phylo_m_animal)

#species term
sp_m_rand <- list()
for(i in 1:length(mar_models_sp)){
sp_m_rand[[i]] <- mar_models_sp[[1]][,"Species_phylo"]
}

sp_m_rand <- unlist(sp_m_rand)
hdr(sp_m_rand)


#resids term

resids_m_rand <- list()
for(i in 1:length(mar_models_sp)){
resids_m_rand[[i]] <- mar_models_sp[[1]][,"units"]
}

resids_m_rand <- unlist(resids_m_rand)
hdr(resids_m_rand)

m_terr <- phylo_m_animal/c(phylo_m_animal + sp_m_rand + resids_m_rand)
hdr(m_terr)


```



plot marine
```{r glm, include=FALSE}



plot(cff_m[, "Max_CFF_Hz"] ~ log10(cff_m[, "Bodymass.g."]),
       col = "white",            
        cex = 1.3,
       pch= 16,
     bty = "n")


points(cff_m[cff_m$Light_Level == "high", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$Light_Level == "high", "Bodymass.g."]),
       col = rgb(247/250,224/250,89/250),
       pch= 16)

points(cff_m[cff_m$Light_Level == "low", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$Light_Level == "low", "Bodymass.g."]),
       col = "grey70",
       pch= 16)


points(cff_m[cff_m$mode_of_life == "pred_ballistic", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_ballistic", "Bodymass.g."]),
       col = "white",
       cex = 0.7,
       pch= 16)




points(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "high", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "high", "Bodymass.g."]),
       col = "white",
       cex = 1.3,
       pch= 16)

points(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "low", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "low", "Bodymass.g."]),
       col = "white",
       cex = 1.3,
       pch= 17)




points(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "high", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "high", "Bodymass.g."]),
       col = rgb(247/250,224/250,89/250),
       cex = 1,
       pch= 17)

points(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "low", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "low", "Bodymass.g."]),
       col = "grey70",
       cex = 1,
       pch= 17)



##high light
abline(summary(full_mar_1)$solutions[1], summary(full_mar_1)$solutions[2],
       col = rgb(247/250,224/250,89/250),
       lty = 4,
       lwd = 3)

##low light
abline(summary(full_mar_1)$solutions[1] + summary(full_mar_1)$solutions[3], 
       summary(full_mar_1)$solutions[2] + summary(full_mar_1)$solutions[8],
       col = "grey70",
       lty = 4,
       lwd = 3)


```




Plot ballistic versus non volant

```{r volatn jitter, include=FALSE}


plot(log10(cff_m[, "CFF"]) ~ jitter(as.numeric(cff_m[, "mode_of_life"])),
       col = "white",
       pch= 16,
     bty = "n",
     xlim = c(0.5,3.5),
      xaxt = "n",
     ylab = "Log10 CFF",
     )

axis(1, at=1:3, labels= c("forage", 
                          "ballistic", 
                          "pursuit"))

points(log10(cff_m[cff_m$forage_light_level == "low", "CFF"]) ~ jitter(as.numeric(cff_m[cff_m$forage_light_level == "low" & cff_m$habitat != "volant", "mode_of_life"]), 0.5),
       col = "grey70",
       pch= 16)

points(log10(cff_m[cff_m$forage_light_level == "high", "CFF"]) ~ jitter(as.numeric(cff_m[cff_m$forage_light_level == "high", "mode_of_life"]), 0.5),
       col = rgb(247/250,224/250,89/250),
       pch= 16)


```

